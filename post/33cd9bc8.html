<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>异地云服务器（公网）搭建k8s集群 | Cherain-</title><meta name="keywords" content="kubernetes"><meta name="author" content="Cherain-"><meta name="copyright" content="Cherain-"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文适用于自己没有足够的局域网服务器，想利用多个异地云服务器搭建k8s！！！   机器配置 主节点centos8.5（阿里云ECS）机器名：master公网ip：47.100.238.0 从节点centos8.2（腾讯云EVM）机器名：node1公网ip：1.117.142.4 从节点centos8.5（阿里云ECS）机器名：node2公网ip：47.95.8.94  设置hostname ma">
<meta property="og:type" content="article">
<meta property="og:title" content="异地云服务器（公网）搭建k8s集群">
<meta property="og:url" content="https://www.cherain-wh.cloud/post/33cd9bc8.html">
<meta property="og:site_name" content="Cherain-">
<meta property="og:description" content="本文适用于自己没有足够的局域网服务器，想利用多个异地云服务器搭建k8s！！！   机器配置 主节点centos8.5（阿里云ECS）机器名：master公网ip：47.100.238.0 从节点centos8.2（腾讯云EVM）机器名：node1公网ip：1.117.142.4 从节点centos8.5（阿里云ECS）机器名：node2公网ip：47.95.8.94  设置hostname ma">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.cherain-wh.cloud/img/money.jpg">
<meta property="article:published_time" content="2022-07-18T08:52:25.000Z">
<meta property="article:modified_time" content="2023-03-14T07:43:49.953Z">
<meta property="article:author" content="Cherain-">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.cherain-wh.cloud/img/money.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.cherain-wh.cloud/post/33cd9bc8"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '异地云服务器（公网）搭建k8s集群',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2023-03-14 15:43:49'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/06/12/XgDaAe.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">222</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">78</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/money.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cherain-</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">异地云服务器（公网）搭建k8s集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-18T08:52:25.000Z" title="发表于 2022-07-18 16:52:25">2022-07-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-14T07:43:49.953Z" title="更新于 2023-03-14 15:43:49">2023-03-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/kubernetes/">kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="异地云服务器（公网）搭建k8s集群"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>本文适用于自己没有足够的局域网服务器，想利用多个异地云服务器搭建k8s！！！</p>
</blockquote>
<hr>
<h1 id="机器配置"><a href="#机器配置" class="headerlink" title="机器配置"></a>机器配置</h1><ul>
<li>主节点centos8.5（阿里云ECS）<br>机器名：master<br>公网ip：47.100.238.0</li>
<li>从节点centos8.2（腾讯云EVM）<br>机器名：node1<br>公网ip：1.117.142.4</li>
<li>从节点centos8.5（阿里云ECS）<br>机器名：node2<br>公网ip：47.95.8.94</li>
</ul>
<h1 id="设置hostname"><a href="#设置hostname" class="headerlink" title="设置hostname"></a>设置hostname</h1><ul>
<li>master节点设置：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname master</span><br></pre></td></tr></table></figure>

<ul>
<li>node1节点设置：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node1</span><br></pre></td></tr></table></figure>

<ul>
<li><p>node1节点设置：</p>
<p>hostnamectl set-hostname node2</p>
</li>
</ul>
<h1 id="修改-x2F-etc-x2F-hosts文件"><a href="#修改-x2F-etc-x2F-hosts文件" class="headerlink" title="修改&#x2F;etc&#x2F;hosts文件"></a>修改&#x2F;etc&#x2F;hosts文件</h1><h3 id="所有节点都需要！！！"><a href="#所有节点都需要！！！" class="headerlink" title="所有节点都需要！！！"></a><strong>所有节点都需要！！！</strong></h3><p><strong>将127.0.0.1 和hostname绑定</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/18/jo31Og.png" alt="jo31Og.png"></p>
<h1 id="配置节点间ssh互信"><a href="#配置节点间ssh互信" class="headerlink" title="配置节点间ssh互信"></a>配置节点间ssh互信</h1><h3 id="所有节点都需要！！！-1"><a href="#所有节点都需要！！！-1" class="headerlink" title="所有节点都需要！！！"></a><strong>所有节点都需要！！！</strong></h3><p><strong>配置ssh互信，那么节点之间就能无密访问，方便日后执行自动化部署</strong></p>
<pre><code>ssh-keygen     # 一路回车即可
</code></pre>
<p><strong>拷贝master公钥到其他节点（默认的文件名为.ssh&#x2F;id_rsa.pub）</strong></p>
<pre><code>ssh-copy-id -i .ssh/id_rsa.pub  用户名字@1.117.142.4（节点node1的ip）
</code></pre>
<blockquote>
<p>执行之后会让你输入服务器的密码，同时也需要把node2的ip执行一次！！！这里我执行完之后，又在node1服务器上把命令里的ip替换成master和node2的ip各执行了一次，node2上是master和node1的ip！！！</p>
</blockquote>
<h1 id="系统参数配置"><a href="#系统参数配置" class="headerlink" title="系统参数配置"></a>系统参数配置</h1><h3 id="所有节点都需要！！！-2"><a href="#所有节点都需要！！！-2" class="headerlink" title="所有节点都需要！！！"></a><strong>所有节点都需要！！！</strong></h3><h3 id="1-关闭Selinux"><a href="#1-关闭Selinux" class="headerlink" title="1. 关闭Selinux"></a>1. 关闭Selinux</h3><pre><code>sed -i &#39;s/SELINUX=.*/SELINUX=disabled/g&#39; /etc/selinux/config
</code></pre>
<h3 id="2-永久关闭swap区"><a href="#2-永久关闭swap区" class="headerlink" title="2. 永久关闭swap区"></a>2. 永久关闭swap区</h3><pre><code>swapoff -a
sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab
echo &quot;vm.swappiness = 0&quot;&gt;&gt; /etc/sysctl.conf  
</code></pre>
<h3 id="3-修改内核参数"><a href="#3-修改内核参数" class="headerlink" title="3. 修改内核参数"></a>3. 修改内核参数</h3><pre><code>cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness=0
EOF
</code></pre>
<h3 id="4-更新内核参数"><a href="#4-更新内核参数" class="headerlink" title="4. 更新内核参数"></a>4. 更新内核参数</h3><blockquote>
<p>-p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载</p>
</blockquote>
<pre><code>sysctl -p /etc/sysctl.d/k8s.conf
</code></pre>
<h3 id="5-完整-x2F-etc-x2F-sysctl-conf-配置"><a href="#5-完整-x2F-etc-x2F-sysctl-conf-配置" class="headerlink" title="5. 完整&#x2F;etc&#x2F;sysctl.conf  配置"></a>5. 完整&#x2F;etc&#x2F;sysctl.conf  配置</h3><blockquote>
<p>当然这里阿里云和腾讯云的这个文件内容可能会有点区别，但是没关系</p>
</blockquote>
<pre><code>vm.swappiness = 0
kernel.sysrq = 1

net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

net.ipv4.neigh.default.gc_stale_time = 120

# see details in https://help.aliyun.com/knowledge_detail/39428.html
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.lo.arp_announce = 2
net.ipv4.conf.all.arp_announce = 2

# see details in https://help.aliyun.com/knowledge_detail/41334.html
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_synack_retries = 2
</code></pre>
<h3 id="6-生效-x2F-etc-x2F-sysctl-conf文件设置"><a href="#6-生效-x2F-etc-x2F-sysctl-conf文件设置" class="headerlink" title="6. 生效&#x2F;etc&#x2F;sysctl.conf文件设置"></a>6. 生效&#x2F;etc&#x2F;sysctl.conf文件设置</h3><pre><code>sysctl -p
</code></pre>
<h1 id="建立虚拟网卡"><a href="#建立虚拟网卡" class="headerlink" title="建立虚拟网卡"></a>建立虚拟网卡</h1><h3 id="所有节点都需要！！！-3"><a href="#所有节点都需要！！！-3" class="headerlink" title="所有节点都需要！！！"></a><strong>所有节点都需要！！！</strong></h3><h3 id="1-设置虚拟网卡"><a href="#1-设置虚拟网卡" class="headerlink" title="1. 设置虚拟网卡"></a>1. 设置虚拟网卡</h3><blockquote>
<p>将当前所在服务器的公网ip当做虚拟网卡来对待，以便后续的k8s集群的pod ip采用公网ip来加入集群</p>
</blockquote>
<p><font color="red">注意：这里的命令需要替换你的公网IP进去！！！</font></p>
<pre><code>cat &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:1 &lt;&lt;EOF
BOOTPROTO=static
DEVICE=eth0:1
IPADDR=你的公网IP
PREFIX=32
TYPE=Ethernet
USERCTL=no
ONBOOT=yes
EOF
</code></pre>
<h3 id="2-如果是centos8，需要重启"><a href="#2-如果是centos8，需要重启" class="headerlink" title="2. 如果是centos8，需要重启"></a>2. 如果是centos8，需要重启</h3><p><font color="red">注意：第二步的命令一定要一次性执行，不要拆开！！！</font></p>
<pre><code>nmcli c reload                   #重新载入一下配置文件，不然不能立即生效
nmcli n off &amp;&amp; nmcli n on        #重启所有网络
</code></pre>
<h3 id="3-查看新建的IP是否进去"><a href="#3-查看新建的IP是否进去" class="headerlink" title="3. 查看新建的IP是否进去"></a>3. 查看新建的IP是否进去</h3><pre><code>ifconfig
</code></pre>
<p>成功示例：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/18/joN4jP.png" alt="joN4jP.png"></p>
<h1 id="主机端口设置"><a href="#主机端口设置" class="headerlink" title="主机端口设置"></a>主机端口设置</h1><h3 id="所有节点都需要！！！-4"><a href="#所有节点都需要！！！-4" class="headerlink" title="所有节点都需要！！！"></a><strong>所有节点都需要！！！</strong></h3><h3 id="1-开放服务器端口"><a href="#1-开放服务器端口" class="headerlink" title="1. 开放服务器端口"></a>1. 开放服务器端口</h3><blockquote>
<p>阿里云ECS和腾讯云EVM所有入网方向端口都需要自己手动开启。</p>
</blockquote>
<p>&#x3D;&#x3D;master&#x3D;&#x3D;需要开放的端口有：</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td>Kubernetes API server</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td>etcd server client API</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10251</td>
<td>kube-scheduler</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10252</td>
<td>kube-controller-manager</td>
</tr>
<tr>
<td>UDP</td>
<td>入站</td>
<td>8472</td>
<td>k8s fannel vxlan</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;node1、node2&#x3D;&#x3D;需要开放的端口有：</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubernetes API server</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td>k8s NodePort ServicesI</td>
</tr>
</tbody></table>
<p>去阿里云和腾讯云把上面这几个端口按对应节点开放出来就可以了，操作类似：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/793961">阿里云服务器开放端口教程</a><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/19/jTArfH.png" alt="jTArfH.png"></p>
<h1 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h1><h3 id="所有节点都需要！！！-5"><a href="#所有节点都需要！！！-5" class="headerlink" title="所有节点都需要！！！"></a><strong>所有节点都需要！！！</strong></h3><p><font color="red">注意：在安装docker和kubernetes前一定要确定好各自的版本</font></p>
<h3 id="1-首先查询是否存在docker服务"><a href="#1-首先查询是否存在docker服务" class="headerlink" title="1. 首先查询是否存在docker服务"></a>1. 首先查询是否存在docker服务</h3><pre><code>docker version
</code></pre>
<h3 id="2-卸载docker服务（可选）"><a href="#2-卸载docker服务（可选）" class="headerlink" title="2. 卸载docker服务（可选）"></a>2. 卸载docker服务（可选）</h3><p><font color="red">如果你当前存在的docker版本符合你的需求，可以忽略以下卸载和安装步骤</font></p>
<pre><code>systemctl stop docker
yum remove docker-ce docker-ce-cli containerd.io
rm -rf /var/lib/docker
rm -rf /var/lib/containerd
</code></pre>
<h3 id="1-查看当前可用版本"><a href="#1-查看当前可用版本" class="headerlink" title="1. 查看当前可用版本"></a>1. 查看当前可用版本</h3><pre><code>yum list docker-ce --showduplicates | sort -r
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/19/jTnT9U.png" alt="jTnT9U.png"></p>
<h3 id="2-安装指定版本的docker（二选一）"><a href="#2-安装指定版本的docker（二选一）" class="headerlink" title="2. 安装指定版本的docker（二选一）"></a>2. 安装指定版本的docker（二选一）</h3><p>将红框部分的版本号替换到下面的命令中即可—-<strong>这里我安装的是19.03的版本</strong></p>
<pre><code>yum install docker-ce-3:19.03.13 docker-ce-cli-1:19.03.13 containerd.io 
</code></pre>
<h3 id="2-安装最新版本的docker（二选一）"><a href="#2-安装最新版本的docker（二选一）" class="headerlink" title="2. 安装最新版本的docker（二选一）"></a>2. 安装最新版本的docker（二选一）</h3><pre><code>curl -fsSL https://get.docker.com/ | sh
</code></pre>
<h3 id="3-启动docker"><a href="#3-启动docker" class="headerlink" title="3. 启动docker"></a>3. 启动docker</h3><pre><code>systemctl start docker
</code></pre>
<h3 id="4-将docker加入开启自启服务中"><a href="#4-将docker加入开启自启服务中" class="headerlink" title="4. 将docker加入开启自启服务中"></a>4. 将docker加入开启自启服务中</h3><pre><code>systemctl enable docker
</code></pre>
<h3 id="5-docker安装完成后"><a href="#5-docker安装完成后" class="headerlink" title="5. docker安装完成后"></a>5. docker安装完成后</h3><p>执行下面命令：</p>
<pre><code># 设置守护程序
cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
&#123; 
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;], 
  &quot;log-driver&quot;: &quot;json-file&quot;, 
  &quot;log-opts&quot;: &#123;    
  &quot;max-size&quot;: &quot;100m&quot; 
   &#125;,  
  &quot;storage-driver&quot;: &quot;overlay2&quot;,  
  &quot;storage-opts&quot;: [    
  &quot;overlay2.override_kernel_check=true&quot;  
  ] ,  
  &quot;registry-mirrors&quot;: [&quot;https://xxxxxx.mirror.aliyuncs.com&quot;]
&#125;
EOF
</code></pre>
<p>登录进入阿里云镜像服务中心，获取镜像地址：”registry-mirrors”:<br><a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn-beijing/instances/mirrors">阿里云镜像服务中心地址</a><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/19/jTuhKH.png" alt="jTuhKH.png"></p>
<pre><code>mkdir -p /etc/systemd/system/docker.service.d
</code></pre>
<h3 id="6-重启Docker服务"><a href="#6-重启Docker服务" class="headerlink" title="6. 重启Docker服务"></a>6. 重启Docker服务</h3><pre><code>systemctl daemon-reload
systemctl enable docker
systemctl restart docker
</code></pre>
<h1 id="安装kubernetes"><a href="#安装kubernetes" class="headerlink" title="安装kubernetes"></a>安装kubernetes</h1><h3 id="1-配置源："><a href="#1-配置源：" class="headerlink" title="1. 配置源："></a>1. 配置源：</h3><pre><code>echo &#39;#k8s
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
&#39;&gt;/etc/yum.repos.d/kubernetes.repo
</code></pre>
<h3 id="2-安装依赖"><a href="#2-安装依赖" class="headerlink" title="2. 安装依赖"></a>2. 安装依赖</h3><p>这里我安装的是1.18.20版本：</p>
<pre><code>yum -y install kubelet-1.18.20 kubeadm-1.18.20 kubectl-1.18.20
</code></pre>
<h3 id="3-查看安装后的k8s版本"><a href="#3-查看安装后的k8s版本" class="headerlink" title="3. 查看安装后的k8s版本"></a>3. 查看安装后的k8s版本</h3><pre><code>kubeadm config images list
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/19/jT5SgI.png" alt="jT5SgI.png"></p>
<h3 id="4-重启kubelet"><a href="#4-重启kubelet" class="headerlink" title="4. 重启kubelet"></a>4. 重启kubelet</h3><pre><code>     systemctl daemon-reload
     systemctl enable kubelet
</code></pre>
<h3 id="5-批量拉取k8s镜像"><a href="#5-批量拉取k8s镜像" class="headerlink" title="5. 批量拉取k8s镜像"></a>5. 批量拉取k8s镜像</h3><h4 id="编写脚本文件"><a href="#编写脚本文件" class="headerlink" title="编写脚本文件"></a>编写脚本文件</h4><pre><code>vim docker.sh
</code></pre>
<h4 id="内容："><a href="#内容：" class="headerlink" title="内容："></a>内容：</h4><p>这里只需要修改<font color="red">四个</font>版本号，其他的不用动</p>
<pre><code>set -o errexit
set -o nounset
set -o pipefail

##这里定义版本，按照上面得到的列表自己改一下版本号

KUBE_VERSION=v1.18.20
KUBE_PAUSE_VERSION=3.2
ETCD_VERSION=3.4.3-0
DNS_VERSION=1.6.7

##这是原始仓库名，最后需要改名成这个
GCR_URL=k8s.gcr.io

##这里就是写你要使用的仓库
DOCKERHUB_URL=registry.aliyuncs.com/google_containers

##这里是镜像列表，新版本要把coredns改成coredns/coredns
images=(
kube-proxy:$&#123;KUBE_VERSION&#125;
kube-scheduler:$&#123;KUBE_VERSION&#125;
kube-controller-manager:$&#123;KUBE_VERSION&#125;
kube-apiserver:$&#123;KUBE_VERSION&#125;
pause:$&#123;KUBE_PAUSE_VERSION&#125;
etcd:$&#123;ETCD_VERSION&#125;
coredns:$&#123;DNS_VERSION&#125;
)

##这里是拉取和改名的循环语句
for imageName in $&#123;images[@]&#125; ; do
  docker pull $DOCKERHUB_URL/$imageName
  docker tag $DOCKERHUB_URL/$imageName $GCR_URL/$imageName
  docker rmi $DOCKERHUB_URL/$imageName
done
</code></pre>
<h4 id="执行脚本："><a href="#执行脚本：" class="headerlink" title="执行脚本："></a>执行脚本：</h4><pre><code>chmod u+x docker.sh（先赋予执行权限）
./docker.sh        （执行）
</code></pre>
<h4 id="所有组件pull成功后。查看"><a href="#所有组件pull成功后。查看" class="headerlink" title="所有组件pull成功后。查看"></a>所有组件pull成功后。查看</h4><pre><code>docker images
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/19/jTIuJH.png" alt="jTIuJH.png"></p>
<h1 id="初始化主节点"><a href="#初始化主节点" class="headerlink" title="初始化主节点"></a>初始化主节点</h1><h3 id="只操作master！！！"><a href="#只操作master！！！" class="headerlink" title="只操作master！！！"></a><strong>只操作master！！！</strong></h3><h3 id="1-配置"><a href="#1-配置" class="headerlink" title="1. 配置"></a>1. 配置</h3><p>把下面内容中需要替换的，改为自己master节点的信息，然后整个复制执行</p>
<pre><code>cat &gt; kubeadm-config.yml &lt;&lt;EOF
apiVersion: kubeadm.k8s.io/v1beta2
bootstrapTokens:
  - groups:
      - system:bootstrappers:kubeadm:default-node-token
    token: abcdef.0123456789abcdef
    ttl: 24h0m0s
    usages:
      - signing
      - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: xx.xxx.xxx.xx   #master公网ip 
  bindPort: 6443
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: master  #自己的hostname
  taints:
    - effect: NoSchedule
      key: node-role.kubernetes.io/master
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: &#123;&#125;
dns:
  type: CoreDNS
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
kubernetesVersion: v1.20.0
apiServer:
  certSANs:    
  - master    #请替换为master的hostname
  - master节点的内网IP地址   #请替换为master内网ip
  - xx.xxx.xxx.xx  #请替换为master公网ip地址
  - 10.1.0.1   #不要替换，此IP是serviceSubnet配置的ip地址网段的第一个地址，API的集群地址，部分服务会用到
networking:
  dnsDomain: cluster.local
  podSubnet: 10.244.0.0/16 #pod的网段地址配置
  serviceSubnet: 10.1.0.0/16 #service的网段地址配置
scheduler: &#123;&#125;
EOF
</code></pre>
<h3 id="2-初始化"><a href="#2-初始化" class="headerlink" title="2. 初始化"></a>2. 初始化</h3><h4 id="开始初始化"><a href="#开始初始化" class="headerlink" title="开始初始化"></a>开始初始化</h4><p>如果是1核心或者1G内存的请在末尾添加参数（–ignore-preflight-errors&#x3D;all），否则会初始化失败</p>
<pre><code>kubeadm init --config=kubeadm-config.yml
</code></pre>
<h4 id="同时注意，此步骤成功后，会打印，两个重要信息"><a href="#同时注意，此步骤成功后，会打印，两个重要信息" class="headerlink" title="同时注意，此步骤成功后，会打印，两个重要信息"></a>同时注意，此步骤成功后，会打印，两个重要信息</h4><p>&#x3D;&#x3D;信息1&#x3D;&#x3D;：上面初始化成功后，将会生成kubeconfig文件，用于请求api服务器，如果想不使用root用户进行后续的k8s集群管理的话，请执行下面操作<font color="red">（这一步我没执行，嘻嘻）</font></p>
<pre><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<p>&#x3D;&#x3D;信息2&#x3D;&#x3D;：此信息用于后面工作节点加入主节点使用,这里的信息需要<font color="red">保存起来</font>，以便接下来的node节点能加入集群，此处的token是只能24小时有效期<font color="red">（下面这内容是初始化生成的，现在不需要执行，只要保存起来）</font>。</p>
<pre><code>kubeadm join 47.100.238.0:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:a255ee4b0eefa44a6b23580bbbfbcd7234903d6d33c4efb5d85d7c8f57311f18
</code></pre>
<h4 id="如果初始化失败"><a href="#如果初始化失败" class="headerlink" title="如果初始化失败"></a>如果初始化失败</h4><p>可以执行完下面命令，之后进行重新初始化</p>
<pre><code>kubeadm reset -f

rm -rf /etc/cni /etc/kubernetes /var/lib/dockershim /var/lib/etcd /var/lib/kubelet /var/run/kubernetes ~/.kube/* 
</code></pre>
<p>当然，也可能删除不干净，这个时候，就需要你根据报错手动删除一些文件（大部分情况下不会的）,然后重新初始化成功。</p>
<p>如果集群开启ipvs的话，也需要将ipvs重置，以确保不受之前的错误配置影响</p>
<pre><code>ipvsadm -C
</code></pre>
<h1 id="部署master节点"><a href="#部署master节点" class="headerlink" title="部署master节点"></a>部署master节点</h1><h3 id="只操作master节点！！！"><a href="#只操作master节点！！！" class="headerlink" title="只操作master节点！！！"></a><strong>只操作master节点！！！</strong></h3><h3 id="1-查看token列表（可选）"><a href="#1-查看token列表（可选）" class="headerlink" title="1. 查看token列表（可选）"></a>1. 查看token列表（可选）</h3><pre><code>kubeadm token list
</code></pre>
<p>输出结果：</p>
<pre><code>TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
abcdef.0123456789abcdef   23h         xxxxx  authentication,signing   The default bootstrap token generated by &#39;kubeadm init&#39;.   system:bootstrappers:kubeadm:default-node-token
</code></pre>
<h3 id="2-重新生成token（可选）"><a href="#2-重新生成token（可选）" class="headerlink" title="2. 重新生成token（可选）"></a>2. 重新生成token（可选）</h3><p><font color="red">（此步骤我没用，所以我的token值不变）</font></p>
<pre><code>kubeadm token create
</code></pre>
<h3 id="3-获取ca证书sha256编码hash值（可选）"><a href="#3-获取ca证书sha256编码hash值（可选）" class="headerlink" title="3. 获取ca证书sha256编码hash值（可选）"></a>3. 获取ca证书sha256编码hash值（可选）</h3><pre><code>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#39;s/^.* //&#39;
</code></pre>
<p>输出结果：<br><code>a255ee4b0eefa44a6b23580bbbfbcd7234903d6d33c4efb5d85d7c8f57311f18</code></p>
<h3 id="4-master节点加入集群"><a href="#4-master节点加入集群" class="headerlink" title="4. master节点加入集群"></a>4. master节点加入集群</h3><p><strong>1. 如果你没有重新生成token，可以直接执行上面初始化主节点最后生成的“kubeadm join”信息。</strong></p>
<p><strong>2. 如果你重新在master节点上生成了token，那么也在master节点上重新查看token和证书信息，然后把对应的值替换下来。</strong></p>
<pre><code>kubeadm join --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:a255ee4b0eefa44a6b23580bbbfbcd7234903d6d33c4efb5d85d7c8f57311f18 47.100.238.0:6443
</code></pre>
<p>如果执行完，报错目录不为空，或者文件已存在，或者端口占用这些情况，可以执行下面的命令（视情况而定）</p>
<pre><code>kubeadm join --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:a255ee4b0eefa44a6b23580bbbfbcd7234903d6d33c4efb5d85d7c8f57311f18 47.100.238.0:6443 --ignore-preflight-errors=all
</code></pre>
<p><strong>至此，master节点部署完毕，现在来查看下pod运行情况</strong><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/07/19/j79yxP.png" alt="j79yxP.png"> <font color="red">注意：由于此时k8s的cni组件还没部署，此时的dns日志里面应该会报错，等待cni组件中，所以 coredns 暂时还无法正常启动。</font>放到下面解决了。</p>
<h1 id="kube-proxy代理方案由iptables改为ipvs"><a href="#kube-proxy代理方案由iptables改为ipvs" class="headerlink" title="kube-proxy代理方案由iptables改为ipvs"></a>kube-proxy代理方案由iptables改为ipvs</h1><blockquote>
<p>部署node1、node2节点前的准备工作</p>
</blockquote>
<h3 id="第一步操作所有节点，其他的只操作master节点！！！"><a href="#第一步操作所有节点，其他的只操作master节点！！！" class="headerlink" title="第一步操作所有节点，其他的只操作master节点！！！"></a><strong>第一步操作所有节点，其他的只操作master节点！！！</strong></h3><p>这里的kube-proxy组件默认是使用iptables方案进行启动的，我们来将它改成由ipvs方式启动</p>
<h3 id="1-加载内核模快"><a href="#1-加载内核模快" class="headerlink" title="1.加载内核模快"></a>1.加载内核模快</h3><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><pre><code>cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
</code></pre>
<h4 id="加载系统参数"><a href="#加载系统参数" class="headerlink" title="加载系统参数"></a>加载系统参数</h4><p>-p：从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载</p>
<pre><code>sysctl -p
</code></pre>
<h4 id="显示已载入系统的模块"><a href="#显示已载入系统的模块" class="headerlink" title="显示已载入系统的模块"></a>显示已载入系统的模块</h4><pre><code>lsmod|grep ip_vs
</code></pre>
<h4 id="载入指定的模块"><a href="#载入指定的模块" class="headerlink" title="载入指定的模块"></a>载入指定的模块</h4><pre><code>modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
</code></pre>
<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><pre><code>yum install ipvsadm ipset -y
</code></pre>
<h3 id="2-修改kube-proxy配置"><a href="#2-修改kube-proxy配置" class="headerlink" title="2.修改kube-proxy配置"></a>2.修改kube-proxy配置</h3><pre><code>kubectl edit configmap kube-proxy -n kube-system
</code></pre>
<h4 id="修改内容"><a href="#修改内容" class="headerlink" title="修改内容"></a>修改内容</h4><pre><code>   minSyncPeriod: 0s
      scheduler: &quot;&quot;
      syncPeriod: 30s
    kind: KubeProxyConfiguration
    metricsBindAddress: 127.0.0.1:10249
    mode: &quot;ipvs&quot;                          # 修改此处
    nodePortAddresses: null
</code></pre>
<h3 id="3-查看所有kube-proxy的pod"><a href="#3-查看所有kube-proxy的pod" class="headerlink" title="3. 查看所有kube-proxy的pod"></a>3. 查看所有kube-proxy的pod</h3><pre><code>kubectl get pod -n kube-system
</code></pre>
<h3 id="4-删除所有kube-proxy的pod"><a href="#4-删除所有kube-proxy的pod" class="headerlink" title="4.删除所有kube-proxy的pod"></a>4.删除所有kube-proxy的pod</h3><pre><code>kubectl delete pod xxx -n kube-system
</code></pre>
<h3 id="5-校验"><a href="#5-校验" class="headerlink" title="5.校验"></a>5.校验</h3><p>日志出现Using ipvs Proxier即可</p>
<pre><code>kubectl logs kube-proxy-xxx -n kube-system 
</code></pre>
<h1 id="给集群部署flannel-网络组件"><a href="#给集群部署flannel-网络组件" class="headerlink" title="给集群部署flannel 网络组件"></a>给集群部署flannel 网络组件</h1><blockquote>
<p>部署node1、node2节点前的准备工作</p>
</blockquote>
<h3 id="所有节点都需要！！！-6"><a href="#所有节点都需要！！！-6" class="headerlink" title="所有节点都需要！！！"></a><strong>所有节点都需要！！！</strong></h3><h3 id="1-下载flannel文件"><a href="#1-下载flannel文件" class="headerlink" title="1. 下载flannel文件"></a>1. 下载flannel文件</h3><p>文件地址：<a target="_blank" rel="noopener" href="https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml">https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml</a><br>copy下来，放文件里</p>
<h3 id="2-修改flannel文件"><a href="#2-修改flannel文件" class="headerlink" title="2. 修改flannel文件"></a>2. 修改flannel文件</h3><h4 id="共修改两个地方，一个是args下，添加"><a href="#共修改两个地方，一个是args下，添加" class="headerlink" title="共修改两个地方，一个是args下，添加"></a>共修改两个地方，一个是args下，添加</h4><pre><code>args:
- --public-ip=$(PUBLIC_IP) # 添加此参数，申明公网IP
- --iface=eth0 # 添加此参数，绑定网卡
</code></pre>
<h4 id="然后是env下"><a href="#然后是env下" class="headerlink" title="然后是env下"></a>然后是env下</h4><pre><code>env:
- name: PUBLIC_IP #添加环境变量
valueFrom:
fieldRef:
fieldPath: status.podIP
</code></pre>
<h4 id="完整文件内容"><a href="#完整文件内容" class="headerlink" title="完整文件内容"></a>完整文件内容</h4><pre><code>---
kind: Namespace
apiVersion: v1
metadata:
  name: kube-flannel
  labels:
    pod-security.kubernetes.io/enforce: privileged
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
rules:
- apiGroups:
  - &quot;&quot;
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - &quot;&quot;
  resources:
  - nodes
  verbs:
  - list
  - watch
- apiGroups:
  - &quot;&quot;
  resources:
  - nodes/status
  verbs:
  - patch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
- kind: ServiceAccount
  name: flannel
  namespace: kube-flannel
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flannel
  namespace: kube-flannel
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-flannel-cfg
  namespace: kube-flannel
  labels:
    tier: node
    app: flannel
data:
  cni-conf.json: |
    &#123;
      &quot;name&quot;: &quot;cbr0&quot;,
      &quot;cniVersion&quot;: &quot;0.3.1&quot;,
      &quot;plugins&quot;: [
        &#123;
          &quot;type&quot;: &quot;flannel&quot;,
          &quot;delegate&quot;: &#123;
            &quot;hairpinMode&quot;: true,
            &quot;isDefaultGateway&quot;: true
          &#125;
        &#125;,
        &#123;
          &quot;type&quot;: &quot;portmap&quot;,
          &quot;capabilities&quot;: &#123;
            &quot;portMappings&quot;: true
          &#125;
        &#125;
      ]
    &#125;
  net-conf.json: |
    &#123;
      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,
      &quot;Backend&quot;: &#123;
        &quot;Type&quot;: &quot;vxlan&quot;
      &#125;
    &#125;
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-flannel-ds
  namespace: kube-flannel
  labels:
    tier: node
    app: flannel
spec:
  selector:
    matchLabels:
      app: flannel
  template:
    metadata:
      labels:
        tier: node
        app: flannel
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
      hostNetwork: true
      priorityClassName: system-node-critical
      tolerations:
      - operator: Exists
        effect: NoSchedule
      serviceAccountName: flannel
      initContainers:
      - name: install-cni-plugin
       #image: flannelcni/flannel-cni-plugin:v1.1.0 for ppc64le and mips64le (dockerhub limitations may apply)
        image: rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0
        command:
        - cp
        args:
        - -f
        - /flannel
        - /opt/cni/bin/flannel
        volumeMounts:
        - name: cni-plugin
          mountPath: /opt/cni/bin
      - name: install-cni
       #image: flannelcni/flannel:v0.18.1 for ppc64le and mips64le (dockerhub limitations may apply)
        image: rancher/mirrored-flannelcni-flannel:v0.18.1
        command:
        - cp
        args:
        - -f
        - /etc/kube-flannel/cni-conf.json
        - /etc/cni/net.d/10-flannel.conflist
        volumeMounts:
        - name: cni
          mountPath: /etc/cni/net.d
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      containers:
      - name: kube-flannel
       #image: flannelcni/flannel:v0.18.1 for ppc64le and mips64le (dockerhub limitations may apply)
        image: rancher/mirrored-flannelcni-flannel:v0.18.1
        command:
        - /opt/bin/flanneld
        args:
        - --ip-masq
        - --kube-subnet-mgr
        - --public-ip=$(PUBLIC_IP) # 添加此参数，申明公网IP
        - --iface=eth0 # 添加此参数，绑定网卡
        resources:
          requests:
            cpu: &quot;100m&quot;
            memory: &quot;50Mi&quot;
          limits:
            cpu: &quot;100m&quot;
            memory: &quot;50Mi&quot;
        securityContext:
          privileged: false
          capabilities:
            add: [&quot;NET_ADMIN&quot;, &quot;NET_RAW&quot;]
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: EVENT_QUEUE_DEPTH
          value: &quot;5000&quot;
        - name: PUBLIC_IP #添加环境变量
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: run
          mountPath: /run/flannel
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
        - name: xtables-lock
          mountPath: /run/xtables.lock
      volumes:
      - name: run
        hostPath:
          path: /run/flannel
      - name: cni-plugin
        hostPath:
          path: /opt/cni/bin
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: flannel-cfg
        configMap:
          name: kube-flannel-cfg
      - name: xtables-lock
        hostPath:
          path: /run/xtables.lock
          type: FileOrCreate
</code></pre>
<h3 id="3-执行flannel文件："><a href="#3-执行flannel文件：" class="headerlink" title="3. 执行flannel文件："></a>3. 执行flannel文件：</h3><pre><code>  kubectl apply -f kube-flannel.yml
</code></pre>
<h3 id="4-执行完后可以在查看k8s集群的pod节点："><a href="#4-执行完后可以在查看k8s集群的pod节点：" class="headerlink" title="4. 执行完后可以在查看k8s集群的pod节点："></a>4. 执行完后可以在查看k8s集群的pod节点：</h3><pre><code>  kubectl get pod -n kube-system -o wide
</code></pre>
<p>可以发现此时coredns都启动成功。</p>
<pre><code>kubectl get pod -n kube-flannel -o wide
</code></pre>
<p>可以发现此时flannel也启动成功。</p>
<h1 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h1><pre><code>  kubectl get cs
</code></pre>
<p>会发现此时其实 scheduler 和controller manager 健康检查是失败的，状态都是：<font color="red">Unhealthy</font></p>
<h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><h4 id="1-去掉配置文件里“-–port-x3D-0-”这个设置"><a href="#1-去掉配置文件里“-–port-x3D-0-”这个设置" class="headerlink" title="1. 去掉配置文件里“ –port&#x3D;0 ”这个设置"></a>1. 去掉配置文件里“ –port&#x3D;0 ”这个设置</h4><p><strong>配置文件路径：</strong></p>
<pre><code>/etc/kubernetes/manifests/kube-scheduler.yaml
/etc/kubernetes/manifests/kube-controller-manager.yaml
</code></pre>
<h4 id="2-重启-sudo-systemctl-restart-kubelet"><a href="#2-重启-sudo-systemctl-restart-kubelet" class="headerlink" title="2. 重启 sudo systemctl restart kubelet"></a>2. 重启 sudo systemctl restart kubelet</h4><h4 id="3-重新查看-kubectl-get-cs-应该就解决问题了。"><a href="#3-重新查看-kubectl-get-cs-应该就解决问题了。" class="headerlink" title="3. 重新查看 kubectl get cs 应该就解决问题了。"></a>3. 重新查看 kubectl get cs 应该就解决问题了。</h4><h1 id="配置k8s集群-命令补全"><a href="#配置k8s集群-命令补全" class="headerlink" title="配置k8s集群 命令补全"></a>配置k8s集群 命令补全</h1><h3 id="只操作master节点！！！-1"><a href="#只操作master节点！！！-1" class="headerlink" title="只操作master节点！！！"></a><strong>只操作master节点！！！</strong></h3><pre><code>yum install -y bash-completion



source &lt;(kubectl completion bash)
echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc
source ~/.bashrc
</code></pre>
<h1 id="部署node节点"><a href="#部署node节点" class="headerlink" title="部署node节点"></a>部署node节点</h1><p>执行join命令前需要做调整。</p>
<h3 id="1-修改kubelet启动参数（重点，所有node节点都要操作）"><a href="#1-修改kubelet启动参数（重点，所有node节点都要操作）" class="headerlink" title="1. 修改kubelet启动参数（重点，所有node节点都要操作）"></a>1. 修改kubelet启动参数（重点，所有node节点都要操作）</h3><h4 id="在末尾添加参数-–node-ip-x3D-node节点的公网IP"><a href="#在末尾添加参数-–node-ip-x3D-node节点的公网IP" class="headerlink" title="在末尾添加参数 –node-ip&#x3D;node节点的公网IP"></a>在末尾添加参数 –node-ip&#x3D;node节点的公网IP</h4><pre><code>vim /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
</code></pre>
<p><font color="red">注意，这步很重要，如果不做，节点仍然会使用内网IP注册进集群</font></p>
<h4 id="文件内容："><a href="#文件内容：" class="headerlink" title="文件内容："></a>文件内容：</h4><pre><code># Note: This dropin only works with kubeadm and kubelet v1.11+
[Service]
Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;
Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;
# This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
EnvironmentFile=-/etc/sysconfig/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS --node-ip=1.117.142.4
</code></pre>
<h3 id="2-将node1、node2加入集群"><a href="#2-将node1、node2加入集群" class="headerlink" title="2. 将node1、node2加入集群"></a>2. 将node1、node2加入集群</h3><p>node1、node2各执行一次刚才master提示的join命令</p>
<pre><code>kubeadm join 47.100.238.0:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:a255ee4b0eefa44a6b23580bbbfbcd7234903d6d33c4efb5d85d7c8f57311f18
</code></pre>
<h3 id="3-查看是否添加进集群"><a href="#3-查看是否添加进集群" class="headerlink" title="3. 查看是否添加进集群"></a>3. 查看是否添加进集群</h3><pre><code>kubectl get pod -n kube-system -o wide
</code></pre>
<h1 id="重置集群"><a href="#重置集群" class="headerlink" title="重置集群"></a>重置集群</h1><p>在搭建集群时，可能会遇到节点配置失败的情况，此时可以将该节点移出集群，在将节点移出集群时，应该将该节点上正在运行的Pod进行驱离。</p>
<pre><code>例如：
驱离名为&quot;k8s-node-1&quot;的节点上的pod（master上操作）
[root@master ~]# kubectl drain k8s-node-1 --delete-local-data --force --ignore-daemonsets


删除节点（master上）
[root@master ~]# kubectl delete node k8s-node-1


重置节点(node上-也就是在被删除的节点上)
[root@node1 ~]# kubeadm reset


需要注意：
注1：需要把master也驱离、删除、重置，这里给我坑死了，第一次没有驱离和删除master，最后的结果是查看结果一切正常，但coredns死活不能用，切勿尝试
</code></pre>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><div class="post_share"><div class="social-share" data-image="/img/money.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://s1.ax1x.com/2022/11/28/za0KAA.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2022/11/28/za0KAA.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">机器配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEhostname"><span class="toc-text">设置hostname</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-x2F-etc-x2F-hosts%E6%96%87%E4%BB%B6"><span class="toc-text">修改&#x2F;etc&#x2F;hosts文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81"><span class="toc-text">所有节点都需要！！！</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E9%97%B4ssh%E4%BA%92%E4%BF%A1"><span class="toc-text">配置节点间ssh互信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81-1"><span class="toc-text">所有节点都需要！！！</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">系统参数配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81-2"><span class="toc-text">所有节点都需要！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%B3%E9%97%ADSelinux"><span class="toc-text">1. 关闭Selinux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B0%B8%E4%B9%85%E5%85%B3%E9%97%ADswap%E5%8C%BA"><span class="toc-text">2. 永久关闭swap区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="toc-text">3. 修改内核参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9B%B4%E6%96%B0%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="toc-text">4. 更新内核参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%AE%8C%E6%95%B4-x2F-etc-x2F-sysctl-conf-%E9%85%8D%E7%BD%AE"><span class="toc-text">5. 完整&#x2F;etc&#x2F;sysctl.conf  配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%94%9F%E6%95%88-x2F-etc-x2F-sysctl-conf%E6%96%87%E4%BB%B6%E8%AE%BE%E7%BD%AE"><span class="toc-text">6. 生效&#x2F;etc&#x2F;sysctl.conf文件设置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1"><span class="toc-text">建立虚拟网卡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81-3"><span class="toc-text">所有节点都需要！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AE%BE%E7%BD%AE%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1"><span class="toc-text">1. 设置虚拟网卡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A6%82%E6%9E%9C%E6%98%AFcentos8%EF%BC%8C%E9%9C%80%E8%A6%81%E9%87%8D%E5%90%AF"><span class="toc-text">2. 如果是centos8，需要重启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E6%96%B0%E5%BB%BA%E7%9A%84IP%E6%98%AF%E5%90%A6%E8%BF%9B%E5%8E%BB"><span class="toc-text">3. 查看新建的IP是否进去</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E7%AB%AF%E5%8F%A3%E8%AE%BE%E7%BD%AE"><span class="toc-text">主机端口设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81-4"><span class="toc-text">所有节点都需要！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BC%80%E6%94%BE%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%8F%A3"><span class="toc-text">1. 开放服务器端口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85"><span class="toc-text">Docker安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81-5"><span class="toc-text">所有节点都需要！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%A6%96%E5%85%88%E6%9F%A5%E8%AF%A2%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8docker%E6%9C%8D%E5%8A%A1"><span class="toc-text">1. 首先查询是否存在docker服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8D%B8%E8%BD%BDdocker%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-text">2. 卸载docker服务（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E5%8F%AF%E7%94%A8%E7%89%88%E6%9C%AC"><span class="toc-text">1. 查看当前可用版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84docker%EF%BC%88%E4%BA%8C%E9%80%89%E4%B8%80%EF%BC%89"><span class="toc-text">2. 安装指定版本的docker（二选一）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84docker%EF%BC%88%E4%BA%8C%E9%80%89%E4%B8%80%EF%BC%89"><span class="toc-text">2. 安装最新版本的docker（二选一）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%90%AF%E5%8A%A8docker"><span class="toc-text">3. 启动docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B0%86docker%E5%8A%A0%E5%85%A5%E5%BC%80%E5%90%AF%E8%87%AA%E5%90%AF%E6%9C%8D%E5%8A%A1%E4%B8%AD"><span class="toc-text">4. 将docker加入开启自启服务中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-docker%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90%E5%90%8E"><span class="toc-text">5. docker安装完成后</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E9%87%8D%E5%90%AFDocker%E6%9C%8D%E5%8A%A1"><span class="toc-text">6. 重启Docker服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kubernetes"><span class="toc-text">安装kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE%E6%BA%90%EF%BC%9A"><span class="toc-text">1. 配置源：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-text">2. 安装依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E5%AE%89%E8%A3%85%E5%90%8E%E7%9A%84k8s%E7%89%88%E6%9C%AC"><span class="toc-text">3. 查看安装后的k8s版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%87%8D%E5%90%AFkubelet"><span class="toc-text">4. 重启kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%89%B9%E9%87%8F%E6%8B%89%E5%8F%96k8s%E9%95%9C%E5%83%8F"><span class="toc-text">5. 批量拉取k8s镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC%E6%96%87%E4%BB%B6"><span class="toc-text">编写脚本文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%EF%BC%9A"><span class="toc-text">内容：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%EF%BC%9A"><span class="toc-text">执行脚本：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E7%BB%84%E4%BB%B6pull%E6%88%90%E5%8A%9F%E5%90%8E%E3%80%82%E6%9F%A5%E7%9C%8B"><span class="toc-text">所有组件pull成功后。查看</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-text">初始化主节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E6%93%8D%E4%BD%9Cmaster%EF%BC%81%EF%BC%81%EF%BC%81"><span class="toc-text">只操作master！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE"><span class="toc-text">1. 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">2. 初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">开始初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%97%B6%E6%B3%A8%E6%84%8F%EF%BC%8C%E6%AD%A4%E6%AD%A5%E9%AA%A4%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E4%BC%9A%E6%89%93%E5%8D%B0%EF%BC%8C%E4%B8%A4%E4%B8%AA%E9%87%8D%E8%A6%81%E4%BF%A1%E6%81%AF"><span class="toc-text">同时注意，此步骤成功后，会打印，两个重要信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%B1%E8%B4%A5"><span class="toc-text">如果初始化失败</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2master%E8%8A%82%E7%82%B9"><span class="toc-text">部署master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E6%93%8D%E4%BD%9Cmaster%E8%8A%82%E7%82%B9%EF%BC%81%EF%BC%81%EF%BC%81"><span class="toc-text">只操作master节点！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9F%A5%E7%9C%8Btoken%E5%88%97%E8%A1%A8%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-text">1. 查看token列表（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%87%8D%E6%96%B0%E7%94%9F%E6%88%90token%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-text">2. 重新生成token（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96ca%E8%AF%81%E4%B9%A6sha256%E7%BC%96%E7%A0%81hash%E5%80%BC%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-text">3. 获取ca证书sha256编码hash值（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-master%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-text">4. master节点加入集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kube-proxy%E4%BB%A3%E7%90%86%E6%96%B9%E6%A1%88%E7%94%B1iptables%E6%94%B9%E4%B8%BAipvs"><span class="toc-text">kube-proxy代理方案由iptables改为ipvs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E6%93%8D%E4%BD%9C%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%8C%E5%85%B6%E4%BB%96%E7%9A%84%E5%8F%AA%E6%93%8D%E4%BD%9Cmaster%E8%8A%82%E7%82%B9%EF%BC%81%EF%BC%81%EF%BC%81"><span class="toc-text">第一步操作所有节点，其他的只操作master节点！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8A%A0%E8%BD%BD%E5%86%85%E6%A0%B8%E6%A8%A1%E5%BF%AB"><span class="toc-text">1.加载内核模快</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0"><span class="toc-text">加载系统参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E5%B7%B2%E8%BD%BD%E5%85%A5%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-text">显示已载入系统的模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BD%E5%85%A5%E6%8C%87%E5%AE%9A%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-text">载入指定的模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-text">安装依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9kube-proxy%E9%85%8D%E7%BD%AE"><span class="toc-text">2.修改kube-proxy配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%86%85%E5%AE%B9"><span class="toc-text">修改内容</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89kube-proxy%E7%9A%84pod"><span class="toc-text">3. 查看所有kube-proxy的pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89kube-proxy%E7%9A%84pod"><span class="toc-text">4.删除所有kube-proxy的pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%A0%A1%E9%AA%8C"><span class="toc-text">5.校验</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%99%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2flannel-%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6"><span class="toc-text">给集群部署flannel 网络组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81-6"><span class="toc-text">所有节点都需要！！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BDflannel%E6%96%87%E4%BB%B6"><span class="toc-text">1. 下载flannel文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9flannel%E6%96%87%E4%BB%B6"><span class="toc-text">2. 修改flannel文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BF%AE%E6%94%B9%E4%B8%A4%E4%B8%AA%E5%9C%B0%E6%96%B9%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%98%AFargs%E4%B8%8B%EF%BC%8C%E6%B7%BB%E5%8A%A0"><span class="toc-text">共修改两个地方，一个是args下，添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%84%B6%E5%90%8E%E6%98%AFenv%E4%B8%8B"><span class="toc-text">然后是env下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-text">完整文件内容</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8Cflannel%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-text">3. 执行flannel文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%89%A7%E8%A1%8C%E5%AE%8C%E5%90%8E%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%9F%A5%E7%9C%8Bk8s%E9%9B%86%E7%BE%A4%E7%9A%84pod%E8%8A%82%E7%82%B9%EF%BC%9A"><span class="toc-text">4. 执行完后可以在查看k8s集群的pod节点：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-text">检查集群状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-text">解决方案：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8E%BB%E6%8E%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%87%8C%E2%80%9C-%E2%80%93port-x3D-0-%E2%80%9D%E8%BF%99%E4%B8%AA%E8%AE%BE%E7%BD%AE"><span class="toc-text">1. 去掉配置文件里“ –port&#x3D;0 ”这个设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%87%8D%E5%90%AF-sudo-systemctl-restart-kubelet"><span class="toc-text">2. 重启 sudo systemctl restart kubelet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%87%8D%E6%96%B0%E6%9F%A5%E7%9C%8B-kubectl-get-cs-%E5%BA%94%E8%AF%A5%E5%B0%B1%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E4%BA%86%E3%80%82"><span class="toc-text">3. 重新查看 kubectl get cs 应该就解决问题了。</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEk8s%E9%9B%86%E7%BE%A4-%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8"><span class="toc-text">配置k8s集群 命令补全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E6%93%8D%E4%BD%9Cmaster%E8%8A%82%E7%82%B9%EF%BC%81%EF%BC%81%EF%BC%81-1"><span class="toc-text">只操作master节点！！！</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2node%E8%8A%82%E7%82%B9"><span class="toc-text">部署node节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BF%AE%E6%94%B9kubelet%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%8C%E6%89%80%E6%9C%89node%E8%8A%82%E7%82%B9%E9%83%BD%E8%A6%81%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-text">1. 修改kubelet启动参数（重点，所有node节点都要操作）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%9C%AB%E5%B0%BE%E6%B7%BB%E5%8A%A0%E5%8F%82%E6%95%B0-%E2%80%93node-ip-x3D-node%E8%8A%82%E7%82%B9%E7%9A%84%E5%85%AC%E7%BD%91IP"><span class="toc-text">在末尾添加参数 –node-ip&#x3D;node节点的公网IP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%EF%BC%9A"><span class="toc-text">文件内容：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B0%86node1%E3%80%81node2%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-text">2. 将node1、node2加入集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E6%B7%BB%E5%8A%A0%E8%BF%9B%E9%9B%86%E7%BE%A4"><span class="toc-text">3. 查看是否添加进集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><span class="toc-text">重置集群</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/money.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Cherain-</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src='https://images.cherain-wh.cloud/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png'> <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11011402013496" style="color:#f72b07" target="_blank">京公网安备 11011402013496号</a> <a href="https://beian.miit.gov.cn/" style="color:#f72b07" target="_blank">京ICP备2022034151号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/medium-zoom/1.0.6/medium-zoom.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comment.plmm.space/',
      region: 'ap-shanghai',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comment.plmm.space/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/twikoo/1.4.18/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.95},"log":false});</script></body></html>